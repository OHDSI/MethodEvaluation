<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running the OHDSI Methods Benchmark • MethodEvaluation</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running the OHDSI Methods Benchmark">
<meta property="og:description" content="MethodEvaluation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MethodEvaluation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/OhdsiMethodsBenchmark.html">Running the OHDSI Methods Benchmark</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/MethodEvaluation/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running the OHDSI Methods Benchmark</h1>
                        <h4 data-toc-skip class="author">Martijn J.
Schuemie</h4>
            
            <h4 data-toc-skip class="date">2023-06-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/MethodEvaluation/blob/HEAD/vignettes/OhdsiMethodsBenchmark.Rmd" class="external-link"><code>vignettes/OhdsiMethodsBenchmark.Rmd</code></a></small>
      <div class="hidden name"><code>OhdsiMethodsBenchmark.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>When designing an observational study, there are many study designs
to choose from, and many additional choices to make, and it is often
unclear how these choices will affect the accuracy of the results.
(e.g. If I match on propensity scores, will that lead to more or less
bias than when I stratify? What about power?) The literature contains
many papers evaluating one design choice at a time, but often with
unsatisfactory scientific rigor; typically, a method is evaluated on one
or two exemplar study from which we cannot generalize, or by using
simulations which have an unclear relationship with the real world.</p>
<p>This vignette describes the OHDSI Methods Benchmark for evaluating
population-level estimation methods, a benchmark that can inform on how
a particular study design and set of analysis choices perform in
general. The benchmark consists of a <strong>gold standard</strong> of
research hypothesis where the truth is known, and a set of
<strong>metrics</strong> for characterizing a methods performance when
applied to the gold standard. We distinguish between two types of tasks:
(1) estimation of the average effect of an exposure on an outcome
relative to no exposure (effect estimation), and (2) estimation of the
average effect of an exposure on an outcome relative to another exposure
(comparative effect estimation). The benchmark allows evaluation of a
method on either or both tasks.</p>
<p>This benchmark builds on previous efforts in EU-ADR, OMOP, and the
WHO, adding the ability to evaluate methods on both tasks, and using
synthetic positive controls as real positive controls have been observed
to be problematic in the past.</p>
<div class="section level3">
<h3 id="gold-standard">Gold standard<a class="anchor" aria-label="anchor" href="#gold-standard"></a>
</h3>
<p>The gold standard comprises 800 entries, with each item specifying a
target exposure, comparator exposure, outcome, nesting cohort, and true
effect size. The true effect size refers to the absolute effect of the
target on the outcome. Because the comparator is always believed to have
no effect on the outcome, the true effect size also holds for the
relative effect of the target compared to the comparator. Thus, each
entry can be used for evaluating both effect estimation and comparative
effect estimation. The nesting cohort identifies a more homogeneous
subgroup of the population and can be used to evaluate methods such as
the nested case-control design.</p>
<p>Of the total set, 200 entries are real negative controls with a
presumed true relative risk of 1. We select these negative controls by
first picking four diverse outcomes (acute pancreatitis,
gastrointestinal bleeding, inflammatory bowel disease, and stroke) and
four diverse exposures (ciprofloxacin, diclofenac, metformin, and
sertraline). For each of the four outcomes, we create 25 entries with
target and comparator exposures that are not believed to cause the
outcome. To aid the creation of these entries, we generate candidate
lists of negative controls for each of the four main outcomes and four
main exposures using an automated procedure, drawing on literature,
product labels, and spontaneous reports. These candidates are used to
construct target-comparator-outcome triplets where neither the target
nor the exposure causes the outcome, and the target and comparator were
either previously compared in a randomized trial per ClinicalTrials.gov,
or both had the same four-digit ATC code (same indication) but not the
same five-digit ATC code (different class). These candidates are ranked
on prevalence of the exposures and outcome and manually reviewed until
25 were approved per initial outcome or exposure. Nesting cohorts were
selected by manually reviewing the most prevalent conditions and
procedures on the first day of the target or comparator treatment.</p>
<p>The remaining 600 entries are positive controls, which were
automatically derived from the 200 negative controls by adding synthetic
additional outcomes during the target exposure until a desired incidence
rate ratio was achieved between before and after injection of the
synthetic outcomes. The target incidence rate ratios were 1.25, 2, and
4. To preserve (measured) confounding, predictive models were fitted for
each outcome during target exposure and used to generate probabilities
from which the synthetic outcomes were sampled.</p>
</div>
<div class="section level3">
<h3 id="metrics">Metrics<a class="anchor" aria-label="anchor" href="#metrics"></a>
</h3>
<p>Once a method has been used to produce estimates for the gold
standard the following metrics are computed:</p>
<ul>
<li>
<strong>AUC</strong>: the ability to discriminate between positive
controls and negative controls.</li>
<li>
<strong>Coverage</strong>: how often the true effect size is within
the 95% confidence interval.</li>
<li>
<strong>Mean precision</strong>: Precision is computed as 1 /
(standard error)2, higher precision means narrower confidence intervals.
We use the geometric mean to account for the skewed distribution of the
precision.</li>
<li>
<strong>Mean squared error</strong> (MSE): Mean squared error
between the log of the effect size point-estimate and the log of the
true effect size.</li>
<li>
<strong>Type 1 error</strong>: For negative controls, how often was
the null rejected (at alpha = 0.05). This is equivalent to the false
positive rate and 1 - specificity.</li>
<li>
<strong>Type 2 error</strong>: For positive controls, how often was
the null not rejected (at alpha = 0.05). This is equivalent to the false
negative rate and 1 - sensitivity.</li>
<li>
<strong>Non-estimable</strong>: For how many of the controls was the
method unable to produce an estimate? There can be various reasons why
an estimate cannot be produced, for example because there were no
subjects left after propensity score matching, or because no subjects
remained having the outcome.</li>
</ul>
<p>The Benchmark computes these metrics both overall, as well as
stratified by true effect size, by each of the four initial outcomes and
four initial exposures, and by amount of data as reflected by the
minimum detectable relative risk (MDRR). When a method cannot estimate
an effect, it returns an estimate of 1 with an infinite confidence
interval.</p>
<p>In prior work we described a method for empirically calibrating
p-values and confidence intervals. Briefly, empirical calibration
estimates a systematic error distribution based on the estimates
produced for the negative and positive controls. This systematic error
is then taken into consideration, in addition to the random error, when
computing the confidence interval and p-value. We therefore also report
the performance metrics listed above after calibration, using a
leave-one-out approach: for each control the error distributions are
fitted on all controls except the control being calibrated and its
siblings. By siblings we mean the set of a negative control and the
positive controls derived from that negative control.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-the-benchmark">Running the benchmark<a class="anchor" aria-label="anchor" href="#running-the-benchmark"></a>
</h2>
<p>This section will describe how to run methods against the benchmark
on a particular observational healthcare database. The database needs to
conform to the OMOP Common Data Model (CDM).</p>
<div class="section level3">
<h3 id="specifying-locations-on-the-server-and-local-file-system">Specifying locations on the server and local file system<a class="anchor" aria-label="anchor" href="#specifying-locations-on-the-server-and-local-file-system"></a>
</h3>
<p>We need to specify the following locations on the database
server:</p>
<ul>
<li>The database schema containing the observational healthcare data in
<strong>CDM</strong> format. Only read access is required to this
schema.</li>
<li>A database schema and table name where <strong>outcome
cohorts</strong> can be instantiated. Write access is required to this
schema.</li>
<li>A database schema and table name where <strong>nesting
cohorts</strong> can be instantiated. Write access is required to this
schema.</li>
<li>
<em>On Oracle only</em>: a schema where <strong>temporary
tables</strong> can be created. Write access is required to this schema.
This is required since Oracle doesn’t fully support temp tables like
other database platforms.</li>
</ul>
<p>We also need to specify on the local file system:</p>
<ul>
<li>An <strong>output folder</strong> where all intermediary and final
results can be written. This should not be a network drive, since that
would severely slow down the analyses.</li>
</ul>
<p>Below is example code showing we specify how to connect to the
database server, and the various required locations.
<code>MethodEvaluation</code> uses the <code>DatabaseConnector</code>
package, which provides the <code>createConnectionDetails</code>
function. Type <code><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">?createConnectionDetails</a></code> for the specific
settings required for the various database management systems
(DBMS).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/OHDSI/MethodEvaluation" class="external-link">MethodEvaluation</a></span><span class="op">)</span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span></span>
<span>  dbms <span class="op">=</span> <span class="st">"postgresql"</span>,</span>
<span>  server <span class="op">=</span> <span class="st">"localhost/ohdsi"</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"joe"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"supersecret"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdmDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"my_cdm_data"</span></span>
<span><span class="va">oracleTempSchema</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">outcomeDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"scratch"</span></span>
<span><span class="va">outcomeTable</span> <span class="op">&lt;-</span> <span class="st">"ohdsi_outcomes"</span></span>
<span><span class="va">nestingCohortDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"scratch"</span></span>
<span><span class="va">nestingCohortTable</span> <span class="op">&lt;-</span> <span class="st">"ohdsi_nesting_cohorts"</span></span>
<span><span class="va">outputFolder</span> <span class="op">&lt;-</span> <span class="st">"/home/benchmarkOutput"</span></span>
<span><span class="va">cdmVersion</span> <span class="op">&lt;-</span> <span class="st">"5"</span></span></code></pre></div>
<p>Note that for Microsoft SQL Server, database schemas need to specify
both the database and the schema, so for example
<code>cdmDatabaseSchema &lt;- "my_cdm_data.dbo"</code>.</p>
</div>
<div class="section level3">
<h3 id="creating-all-necessary-cohorts">Creating all necessary cohorts<a class="anchor" aria-label="anchor" href="#creating-all-necessary-cohorts"></a>
</h3>
<p>In order to run our population-level effect estimation method, we
will need to identify the exposures and outcomes of interest. To
identify exposures we will simlpy use the predefined exposure eras in
the <code>drug_era</code> table in the CDM. However, for the outcomes
custom cohorts need to be generated. In addition, some methods such as
the nested case-control design require nesting cohorts to be defined.
The negative control outcome and nesting cohorts can be generated using
the following command:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/createReferenceSetCohorts.html">createReferenceSetCohorts</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  oracleTempSchema <span class="op">=</span> <span class="va">oracleTempSchema</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>  outcomeDatabaseSchema <span class="op">=</span> <span class="va">outcomeDatabaseSchema</span>,</span>
<span>  outcomeTable <span class="op">=</span> <span class="va">outcomeTable</span>,</span>
<span>  nestingDatabaseSchema <span class="op">=</span> <span class="va">nestingCohortDatabaseSchema</span>,</span>
<span>  nestingTable <span class="op">=</span> <span class="va">nestingCohortTable</span>,</span>
<span>  referenceSet <span class="op">=</span> <span class="st">"ohdsiMethodsBenchmark"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This will automatically create the outcome and nesting cohort tables,
and populate them.</p>
<p>The nest step is to create the positive controls. These are generated
by taking the negative controls, and adding synthetic outcomes during
exposed time to achieve predefined relative risks greater than one. The
synthetic outcomes are sampled based on models that are fitted for each
negative control outcome, using predictors extracted from the data.
These positive control outcomes are added to the outcome table.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/synthesizeReferenceSetPositiveControls.html">synthesizeReferenceSetPositiveControls</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  oracleTempSchema <span class="op">=</span> <span class="va">oracleTempSchema</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>  outcomeDatabaseSchema <span class="op">=</span> <span class="va">outcomeDatabaseSchema</span>,</span>
<span>  outcomeTable <span class="op">=</span> <span class="va">outcomeTable</span>,</span>
<span>  maxCores <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  workFolder <span class="op">=</span> <span class="va">outputFolder</span>,</span>
<span>  summaryFileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">outputFolder</span>,</span>
<span>    <span class="st">"allControls.csv"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  referenceSet <span class="op">=</span> <span class="st">"ohdsiMethodsBenchmark"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Fitting the outcome models can take a while. It is recommend to set
the <code>maxCores</code> argument to the number of CPU cores available
in the machine to speed up the process. Note that at the end, a file
will be created called <em>allControls.csv</em> in the output folder
containing the information on the controls:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">allControls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"allControls.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">allControls</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  outcomeId comparatorId targetId targetName comparatorName nestingId                  nestingName        outcomeName             type targetEffectSize trueEffectSize trueEffectSizeFirstExposure oldOutcomeId mdrrTarget</span></span>
<span><span class="co">#&gt; 1         1      1105775  1110942 omalizumab  Aminophylline  37203741 Bronchospasm and obstruction Acute pancreatitis Exposure control                1              1                           1            1   1.421960</span></span>
<span><span class="co">#&gt; 2         1      1110942  1140088 Dyphylline     omalizumab  37203741 Bronchospasm and obstruction Acute pancreatitis Exposure control                1              1                           1            1   1.420173</span></span>
<span><span class="co">#&gt; 3         1      1136422   943634 epinastine levocetirizine  36009773            Rhinitis allergic Acute pancreatitis Exposure control                1              1                           1            1   1.217681</span></span>
<span><span class="co">#&gt; 4         1      1315865 40163718  prasugrel   fondaparinux  37622411              Phlebosclerosis Acute pancreatitis Exposure control                1              1                           1            1   1.196514</span></span>
<span><span class="co">#&gt; 5         1      1315865  1350310 cilostazol   fondaparinux  37622411              Phlebosclerosis Acute pancreatitis Exposure control                1              1                           1            1   1.233415</span></span>
<span><span class="co">#&gt; 6         1      1336926  1311276 vardenafil      tadalafil  36919202           Sexual dysfunction Acute pancreatitis Exposure control                1              1                           1            1   1.097112</span></span>
<span><span class="co">#&gt;   mdrrComparator</span></span>
<span><span class="co">#&gt; 1       1.177202</span></span>
<span><span class="co">#&gt; 2       1.421960</span></span>
<span><span class="co">#&gt; 3       1.085877</span></span>
<span><span class="co">#&gt; 4       1.278911</span></span>
<span><span class="co">#&gt; 5       1.278911</span></span>
<span><span class="co">#&gt; 6       1.060737</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="running-the-method-to-evaluate">Running the method to evaluate<a class="anchor" aria-label="anchor" href="#running-the-method-to-evaluate"></a>
</h3>
<p>Now that we have the controls in place, we can run the method we
would like to evaluate. Here we will run the
<code>SelfControlledCohort</code> package which implements the
Self-Controlled Cohort (SCC) design. We first will first define some SCC
analysis settings to evaluate. Here we define two analysis settings, one
using the length of exposure as the time-at-risk, and one using the
first 30 days after exposure start as the time-at-risk:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/OHDSI/SelfControlledCohort" class="external-link">SelfControlledCohort</a></span><span class="op">)</span></span>
<span><span class="va">runSccArgs1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SelfControlledCohort/man/createRunSelfControlledCohortArgs.html" class="external-link">createRunSelfControlledCohortArgs</a></span><span class="op">(</span></span>
<span>  addLengthOfExposureExposed <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  riskWindowStartExposed <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  riskWindowEndExposed <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  riskWindowEndUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>  addLengthOfExposureUnexposed <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  riskWindowStartUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>  washoutPeriod <span class="op">=</span> <span class="fl">365</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sccAnalysis1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SelfControlledCohort/man/createsccAnalysis.html" class="external-link">createSccAnalysis</a></span><span class="op">(</span></span>
<span>  analysisId <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Length of exposure"</span>,</span>
<span>  runSelfControlledCohortArgs <span class="op">=</span> <span class="va">runSccArgs1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">runSccArgs2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SelfControlledCohort/man/createRunSelfControlledCohortArgs.html" class="external-link">createRunSelfControlledCohortArgs</a></span><span class="op">(</span></span>
<span>  addLengthOfExposureExposed <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  riskWindowStartExposed <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  riskWindowEndExposed <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  riskWindowEndUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>  addLengthOfExposureUnexposed <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  riskWindowStartUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>,</span>
<span>  washoutPeriod <span class="op">=</span> <span class="fl">365</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sccAnalysis2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SelfControlledCohort/man/createsccAnalysis.html" class="external-link">createSccAnalysis</a></span><span class="op">(</span></span>
<span>  analysisId <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"30 days of each exposure"</span>,</span>
<span>  runSelfControlledCohortArgs <span class="op">=</span> <span class="va">runSccArgs2</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sccAnalysisList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sccAnalysis1</span>, <span class="va">sccAnalysis2</span><span class="op">)</span></span></code></pre></div>
<p>Next, we specify all exposure-outcome pairs we want to apply the SCC
design to. Note that we only use the <code>targetId</code> and
<code>outcomeId</code> fields of the controls, because the SCC design
can only be used for effect estimation, and does not support
nesting:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">allControls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"allControls.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">eos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">allControls</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">eos</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">eos</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SelfControlledCohort/man/createExposureOutcome.html" class="external-link">createExposureOutcome</a></span><span class="op">(</span></span>
<span>    exposureId <span class="op">=</span> <span class="va">allControls</span><span class="op">$</span><span class="va">targetId</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    outcomeId <span class="op">=</span> <span class="va">allControls</span><span class="op">$</span><span class="va">outcomeId</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then, we run the SCC method. The following command will execute the
SCC with the specified analysis settings against the exposure-outcome
pairs:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sccResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SelfControlledCohort/man/runSccAnalyses.html" class="external-link">runSccAnalyses</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>  oracleTempSchema <span class="op">=</span> <span class="va">oracleTempSchema</span>,</span>
<span>  exposureTable <span class="op">=</span> <span class="st">"drug_era"</span>,</span>
<span>  outcomeDatabaseSchema <span class="op">=</span> <span class="va">outcomeDatabaseSchema</span>,</span>
<span>  outcomeTable <span class="op">=</span> <span class="va">outcomeTable</span>,</span>
<span>  sccAnalysisList <span class="op">=</span> <span class="va">sccAnalysisList</span>,</span>
<span>  exposureOutcomeList <span class="op">=</span> <span class="va">eos</span>,</span>
<span>  outputFolder <span class="op">=</span> <span class="va">outputFolder</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sccSummary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SelfControlledCohort/man/summarizeAnalyses.html" class="external-link">summarizeAnalyses</a></span><span class="op">(</span><span class="va">sccResult</span>, <span class="va">outputFolder</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">sccSummary</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"sccSummary.csv"</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>This produces a file called <em>sccSummary.csv</em> which contains
the effect size estimates for each analysisId-exposureId-outcomeId
combination.</p>
</div>
<div class="section level3">
<h3 id="packaging-the-evaluation-results">Packaging the evaluation results<a class="anchor" aria-label="anchor" href="#packaging-the-evaluation-results"></a>
</h3>
<p>Now that we have the estimates, we need to feed them back into the
<code>MethodEvaluation</code> package. To do that we need to create two
data frames, one specifying the effect size estimates, the other
providing details on the various analyses.</p>
<p>First, we specify the estimates:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"sccSummary.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  analysisId <span class="op">=</span> <span class="va">estimates</span><span class="op">$</span><span class="va">analysisId</span>,</span>
<span>  targetId <span class="op">=</span> <span class="va">estimates</span><span class="op">$</span><span class="va">exposureId</span>,</span>
<span>  outcomeId <span class="op">=</span> <span class="va">estimates</span><span class="op">$</span><span class="va">outcomeId</span>,</span>
<span>  logRr <span class="op">=</span> <span class="va">estimates</span><span class="op">$</span><span class="va">logRr</span>,</span>
<span>  seLogRr <span class="op">=</span> <span class="va">estimates</span><span class="op">$</span><span class="va">seLogRr</span>,</span>
<span>  ci95Lb <span class="op">=</span> <span class="va">estimates</span><span class="op">$</span><span class="va">irrLb95</span>,</span>
<span>  ci95Ub <span class="op">=</span> <span class="va">estimates</span><span class="op">$</span><span class="va">irrUb95</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">estimates</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   analysisId targetId outcomeId      logRr   seLogRr    ci95Lb    ci95Ub</span></span>
<span><span class="co">#&gt; 1          1  1110942         1 -1.5000000        NA        NA 13.177433</span></span>
<span><span class="co">#&gt; 2          1  1140088         1         NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; 3          1   943634         1         NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; 4          1 40163718         1 -0.4054651 0.6926191 0.1479317  2.234489</span></span>
<span><span class="co">#&gt; 5          1  1350310         1 -0.2876821 0.7038381 0.1642789  2.592973</span></span>
<span><span class="co">#&gt; 6          1  1311276         1 -0.1823216 0.5451585 0.2651910  2.247182</span></span></code></pre>
<p>Next, we create the analysis reference:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a reference of the analysis settings:</span></span>
<span><span class="va">analysisRef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"SelfControlledCohort"</span>,</span>
<span>  analysisId <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  description <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Length of exposure"</span>,</span>
<span>    <span class="st">"30 days of each exposure"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  details <span class="op">=</span> <span class="st">""</span>,</span>
<span>  comparative <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nesting <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  firstExposureOnly <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">analysisRef</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;                 method analysisId              description details comparative</span></span>
<span><span class="co">#&gt; 1 SelfControlledCohort          1       Length of exposure               FALSE</span></span>
<span><span class="co">#&gt; 2 SelfControlledCohort          2 30 days of each exposure               FALSE</span></span>
<span><span class="co">#&gt;   nesting firstExposureOnly</span></span>
<span><span class="co">#&gt; 1   FALSE             FALSE</span></span>
<span><span class="co">#&gt; 2   FALSE             FALSE</span></span></code></pre>
<p>Finally, we supply these two data frames, together with the data
frame with controls to the <code>packageOhdsiBenchmarkResults</code>
function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">allControls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"allControls.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/packageOhdsiBenchmarkResults.html">packageOhdsiBenchmarkResults</a></span><span class="op">(</span></span>
<span>  estimates <span class="op">=</span> <span class="va">estimates</span>,</span>
<span>  controlSummary <span class="op">=</span> <span class="va">allControls</span>,</span>
<span>  analysisRef <span class="op">=</span> <span class="va">analysisRef</span>,</span>
<span>  databaseName <span class="op">=</span> <span class="va">databaseName</span>,</span>
<span>  exportFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"export"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This will generate two CSV files in the export folder. Results from
different methods and databases can all be written to the same export
folder.</p>
</div>
<div class="section level3">
<h3 id="computing-metrics">Computing metrics<a class="anchor" aria-label="anchor" href="#computing-metrics"></a>
</h3>
<p>There are two ways to view the method’s performance metrics: using a
Shiny app, and by generating a data frame.</p>
<div class="section level4">
<h4 id="using-the-shiny-app">Using the Shiny app<a class="anchor" aria-label="anchor" href="#using-the-shiny-app"></a>
</h4>
<p>Run the follow command to launch the Shiny app and view the
metrics:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exportFolder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"export"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/launchMethodEvaluationApp.html">launchMethodEvaluationApp</a></span><span class="op">(</span><span class="va">exportFolder</span><span class="op">)</span></span></code></pre></div>
<p>This will launch a Shiny app as shown in Figure 1.</p>
<div class="figure">
<img src="shiny.png" alt=""><p class="caption">Method Benchmark Shiny app</p>
</div>
<p>Note that the export folder can hold results from multiple methods
and multiple databases.</p>
</div>
<div class="section level4">
<h4 id="generating-a-data-frame">Generating a data frame<a class="anchor" aria-label="anchor" href="#generating-a-data-frame"></a>
</h4>
<p>Alternatively, we can output the metrics to a data frame:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exportFolder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"export"</span><span class="op">)</span></span>
<span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/computeOhdsiBenchmarkMetrics.html">computeOhdsiBenchmarkMetrics</a></span><span class="op">(</span><span class="va">exportFolder</span>,</span>
<span>  mdrr <span class="op">=</span> <span class="fl">1.25</span>,</span>
<span>  stratum <span class="op">=</span> <span class="st">"All"</span>,</span>
<span>  trueEffectSize <span class="op">=</span> <span class="st">"Overall"</span>,</span>
<span>  calibrated <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  comparative <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">metrics</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    database               method analysisId                                           description  auc coverage   meanP  mse type1 type2 nonEstimable</span></span>
<span><span class="co">#&gt; 1     CCAE SelfControlledCohort          1                    Length of exposure 0.89     0.21 1048.97 0.30  0.66  0.08         0.01</span></span>
<span><span class="co">#&gt; 2     CCAE SelfControlledCohort          2                        30 days of each exposure 0.87     0.41  422.25 0.14  0.55  0.11         0.00</span></span></code></pre>
<p>See <code><a href="../reference/computeOhdsiBenchmarkMetrics.html">?computeOhdsiBenchmarkMetrics</a></code> for information on the
various arguments.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martijn Schuemie.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
